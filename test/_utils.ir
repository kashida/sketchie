TODO:
- Command to send events to any elem (mainly mouse click).
- Command to wait (timeout with 0?).
- Command to assert / check dom states.

::sendKeyCode
  code\n\$
  shift\b\? false
  // There seems to be webkit bug that KeyboardEvent not allowing keyCode to be set.
  e := &Event('keyup')
  e.keyCode = code
  e.shiftKey = shift
  e.target = document.body
  document.body.dispatchEvent(e)

::sendKeys = ##
  kstr\s\$
  shift\b\? false
  kstr.split('').forEach(##)
    kchar\s\$
    sendKeyCode(c(kchar.toUpperCase()), shift)

::sendInput = ##
  str\s\$
  sel := window.getSelection()
  node := sel.anchorNode
  offset := sel.anchorOffset
  if node instanceof Text
    current_str := node.wholeText
    node.replaceWholeText(#)
      current_str.substr(0, offset)
      str
      current_str.substr(offset)
    sel.collapse(node, offset + str.length)
  else
    node.innerText = str

::select = ##
  sel\s\$
  => document.querySelector(sel)

::report
  desc\s\$
  xhrPost('/_tr', desc)

::verify = ##
  cond\b\$
  if cond
    =>
  try
    // Make an error to get the stack trace.
    throw &Error()
  catch e
    report(#+)
      '* fail:\n'
      // Dropping the first two lines which are error message ("Error") and
      // this function's scope.
      e.stack.split('\n').slice(2).join('\n')

:
  window.onerror = ##
    err\s\$
    file\s\$
    line\n\$
    report(#+)
      '* error: ' + err + '\n'
      '   ' + file + ' (line ' + line + ')'
