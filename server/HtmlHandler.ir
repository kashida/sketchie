:'header_start
  <!doctype html>
  <html><head>
    <title>Scrawler</title>
    <link rel="shortcut icon" href="/favicon.png" type="image/png" />
    <link rel="icon" href="/favicon.png" type="image/png" />
    <link rel="stylesheet" href="scrawler.css" type="text/css">

:'header_end
    </head><body>

:'footer
  </body></html>

:'script_load
  <script>run_scrawler();</script>

::script_marker = '<!-- SCRAWLER_SCRIPT -->'



::
  @ctxt\RequestContext\$

:post
  // TODO: handle sub-dirs.
  data := header_start + script_marker + header_end
  @ctxt.req.setEncoding('utf8')
  @ctxt.req.on('data', ##)
    chunk\s\$
    data += chunk
  @ctxt.req.once('end', ##)
    data += footer
    _fs.writeFileSync(_path.join('data', @ctxt.path), data)

    // Make the response.
    @ctxt.res.writeHead(200)
    @ctxt.response(200)

:packageList\s\
  code\CodeHandler\$
  => #+
    '<script>\n'
    code.pkgList.map(##).join('')
      line\s\$
      => line + '\n'
    '</script>\n'

:scriptList\s\
  code\CodeHandler\$
  => code.scriptList.map(##).join('')
    file\s\$
    => '<script src="/_s/' + file + '"></script>\n'

:replaceScript
  html\s\$
  code\CodeHandler\$
  => html.replace(script_marker, #+) + script_load
    @.packageList(code)
    @.scriptList(code)

:create
  code\CodeHandler\$
  @ctxt.res.writeHead(200, {'Content-Type': 'text/html'})
  @ctxt.res.write(header_start)
  @ctxt.res.write(@.packageList(code))
  @ctxt.res.write(@.scriptList(code))
  @ctxt.res.write(header_end + footer)
  @ctxt.res.write(script_load)
  @ctxt.response(200)
